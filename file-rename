#!/bin/bash

# File Renaming Assistant Wrapper Script
# This script activates the virtual environment and runs the file renaming assistant

# Resolve the directory of this script (follows symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
VENV_PATH="$SCRIPT_DIR/venv"
SCRIPT_PATH="$SCRIPT_DIR/file_renaming_asst.py"
ORIGINAL_DIR="$PWD"

# Convert relative paths to absolute paths
ARGS=()
for arg in "$@"; do
    # Check if this looks like a relative path (not starting with - and not an absolute path)
    if [[ "$arg" =~ ^\./ ]] || ([[ "$arg" =~ ^[^/-] ]] && [[ -e "$arg" || "$arg" =~ / ]]); then
        # Convert to absolute path
        ARGS+=("$ORIGINAL_DIR/$arg")
    else
        ARGS+=("$arg")
    fi
done

# Change to script directory
cd "$SCRIPT_DIR" || {
    echo "Error: Cannot change to script directory: $SCRIPT_DIR"
    exit 1
}

# Choose Python interpreter (venv if available, otherwise system python3)
if [ -f "$VENV_PATH/bin/activate" ]; then
    # shellcheck source=/dev/null
    source "$VENV_PATH/bin/activate" || {
        echo "Warning: Could not activate virtual environment at $VENV_PATH; falling back to system python3."
    }
    PYTHON_BIN="${VENV_PATH}/bin/python"
else
    PYTHON_BIN="python3"
fi

# Run the Python script with processed arguments
"$PYTHON_BIN" "$SCRIPT_PATH" "${ARGS[@]}"
